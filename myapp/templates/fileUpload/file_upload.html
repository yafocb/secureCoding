<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>File Upload - ì·¨ì•½/ì•ˆì „ ì½”ë“œ ë¹„êµ</title>
  {% load static %}
  <link rel="stylesheet" href="{% static 'css/common.css' %}">
  <link rel="stylesheet" href="{% static 'css/test-pages.css' %}">
  <style>
    /* íŒŒì¼ ì•„ì´í…œ ìŠ¤íƒ€ì¼ ê°œì„  */
    .file-item {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin: 15px 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .file-item.vulnerable {
      border-left: 5px solid #ff6b6b;
      background: #fff5f5;
    }

    .file-item.safe {
      border-left: 5px solid #56ab2f;
      background: #f5fff5;
    }

    /* íŒŒì¼ ì‹¤í–‰ ì„¹ì…˜ */
    .execute-section {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 2px dashed #ff6b6b;
    }

    .execute-warning {
      background: #fff3cd;
      padding: 12px;
      border-radius: 5px;
      border-left: 4px solid #ffc107;
      margin-bottom: 15px;
      font-size: 14px;
      color: #856404;
    }

    .execute-warning strong {
      color: #856404;
    }

    .file-type-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
      margin-left: 8px;
      vertical-align: middle;
    }

    .badge-python { background: #3776ab; color: white; }
    .badge-shell { background: #4eaa25; color: white; }
    .badge-php { background: #777bb3; color: white; }
    .badge-exe { background: #dc3545; color: white; }
    .badge-bat { background: #f0ad4e; color: white; }
    .badge-dangerous { background: #dc3545; color: white; }

    .error-message {
      background: #ffe6e6;
      border-left: 4px solid #ff0000;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      color: #cc0000;
    }

    .execute-form {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .execute-form label {
      white-space: nowrap;
      font-weight: bold;
      color: #333;
      margin: 0;
    }

    .execute-form input[type="text"] {
      flex: 1;
      min-width: 150px;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 5px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
    }

    .execute-btn {
      background: #ff6b6b;
      color: white;
      padding: 10px 25px;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
    }

    .execute-btn:hover {
      background: #ff5252;
      transform: scale(1.05);
    }

    .execute-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    /* ì‹¤í–‰ ê²°ê³¼ ë°•ìŠ¤ */
    .result-box-terminal {
      margin-top: 15px;
      padding: 15px;
      background: #000;
      border-radius: 5px;
      border-left: 4px solid #0f0;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      color: #0f0;
      white-space: pre-wrap;
      word-wrap: break-word;
      max-height: 300px;
      overflow-y: auto;
      display: none;
    }

    .result-box-terminal.show {
      display: block;
    }

    .result-box-terminal.error {
      background: #2c0000;
      color: #ff6b6b;
      border-left-color: #ff6b6b;
    }

    .result-box-terminal.success {
      background: #000;
      color: #0f0;
      border-left-color: #0f0;
    }

    .attack-example {
      background: #f8d7da !important;  /* í•‘í¬ìƒ‰ ë°°ê²½ */
      padding: 15px;
      border-radius: 5px;
      margin: 20px 0;
      border-left: 4px solid #dc3545 !important;  /* ë¹¨ê°„ ì™¼ìª½ í…Œë‘ë¦¬ */
    }

    .attack-example h3 {
      color: #721c24 !important;  /* ì–´ë‘ìš´ ë¹¨ê°• ì œëª© */
      margin-top: 0;
    }

    .attack-example h4 {
      color: #721c24 !important;
      margin-top: 15px;
      margin-bottom: 10px;
    }

    .attack-example ul {
      margin: 10px 0;
      padding-left: 20px;
    }

    .attack-example li {
      list-style-type: disc;  /* ì  í‘œì‹œ */
      color: #721c24;
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <div class="container file-upload">
    <h1>File Upload - ì·¨ì•½/ì•ˆì „ ì½”ë“œ ë¹„êµ</h1>

    <div class="description">
      <strong>íŒŒì¼ ì—…ë¡œë“œ ì·¨ì•½ì ì´ë€?</strong><br>
      ì„œë²„ì—ì„œ ì—…ë¡œë“œë˜ëŠ” íŒŒì¼ì„ ì œëŒ€ë¡œ ê²€ì¦í•˜ì§€ ì•Šìœ¼ë©´,<br>
      ê³µê²©ìê°€ ì›¹ì‰˜ ê°™ì€ ì•…ì„± ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì˜¬ë ¤ì„œ ì„œë²„ì—ì„œ<br>
      <strong>ì„ì˜ ëª…ë ¹ì–´ ì‹¤í–‰</strong>ì´ë‚˜ <strong>ì‹œìŠ¤í…œ ì¥ì•…</strong>ê¹Œì§€ ì´ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </div>

    <!-- ëª¨ë“œ ì„ íƒ (ì·¨ì•½ / ì•ˆì „) -->
    <div class="mode-selector">
      <button
        type="button"
        id="btn-vuln"
        class="mode-btn vulnerable-btn {% if mode == 'safe' %}{% else %}active{% endif %}"
        onclick="setMode('vulnerable')">
        âœ– ì·¨ì•½ì½”ë“œ í…ŒìŠ¤íŠ¸
      </button>

      <button
        type="button"
        id="btn-safe"
        class="mode-btn safe-btn {% if mode == 'safe' %}active{% endif %}"
        onclick="setMode('safe')">
        âœ… ì•ˆì „ì½”ë“œ í…ŒìŠ¤íŠ¸
      </button>
    </div>

    <!-- íŒŒì¼ ì—…ë¡œë“œ í¼ -->
    <form method="post" enctype="multipart/form-data" class="upload-form" id="upload-form">
      {% csrf_token %}
      <input type="hidden" name="mode" id="mode-input" value="{{ mode|default:'vulnerable' }}">

      {# Django Form ì‚¬ìš© #}
      {{ form.upload_file.label_tag }}
      {{ form.upload_file }}

      {# ì—ëŸ¬ ë©”ì‹œì§€ ìë™ í‘œì‹œ #}
      {% if form.upload_file.errors %}
        <div class="error-message">
          {% for error in form.upload_file.errors %}
            <p>âš ï¸ {{ error }}</p>
          {% endfor %}
        </div>
      {% endif %}

      <button type="submit" class="safe-btn" style="width:100%; margin-top:15px;">
        â¬†ï¸ ì—…ë¡œë“œ ë° ê²°ê³¼ í™•ì¸
      </button>
    </form>
    <!-- ëª¨ë‘ ì‚­ì œ ë²„íŠ¼ -->
    {% if uploaded_files %}
      <form method="post" style="text-align: center;" onsubmit="return confirm('ì •ë§ë¡œ ëª¨ë“  íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
        {% csrf_token %}
        <button type="submit" name="clear" value="true" class="clear-btn">
          ğŸ—‘ï¸ ëª¨ë“  íŒŒì¼ ì‚­ì œ
        </button>
      </form>
    {% endif %}

    <!-- ì—…ë¡œë“œëœ íŒŒì¼ ëª©ë¡ -->
    <div class="file-list">
      <h2>ğŸ“‹ ì—…ë¡œë“œëœ íŒŒì¼ ëª©ë¡ ({{ uploaded_files|length }}ê°œ)</h2>

      {% if uploaded_files %}
        {% for file in uploaded_files %}
        <div class="file-item {% if file.mode == 'vulnerable' %}vulnerable{% else %}safe{% endif %}">
          <div class="file-name">
            ğŸ“„ {{ file.name }}
            {% if file.saved_name and file.saved_name != file.name %}
              â†’ {{ file.saved_name }}
            {% endif %}

            {# íŒŒì¼ í˜•ì‹ ë±ƒì§€ í‘œì‹œ #}
            {% if file.file_type %}
              <span class="file-type-badge badge-{{ file.file_type }}">
                {{ file.file_type|upper }}
              </span>
            {% endif %}
          </div>

          <div class="file-info">
            ğŸ“Š í¬ê¸°: {{ file.size }} bytes
            {% if file.mime %}| ğŸ·ï¸ MIME: {{ file.mime }}{% endif %}
            {% if file.dimensions %}| ğŸ“ ì´ë¯¸ì§€ í¬ê¸°: {{ file.dimensions }}{% endif %}
            {% if file.mode %}
              | ëª¨ë“œ:
              {% if file.mode == 'vulnerable' %}
                <span style="color:#dc3545; font-weight:bold;">ì·¨ì•½ì½”ë“œ</span>
              {% else %}
                <span style="color:#28a745; font-weight:bold;">ì•ˆì „ì½”ë“œ</span>
              {% endif %}
            {% endif %}
          </div>

          {# ì·¨ì•½ì½”ë“œ + ì‹¤í–‰ ê°€ëŠ¥í•œ íŒŒì¼ â†’ ì‹¤í–‰ UI í‘œì‹œ #}
          {% if file.mode == 'vulnerable' and file.is_executable %}
          <div class="execute-section">
            <div class="execute-warning">
              <strong>âš ï¸ ìœ„í—˜!</strong>
              ì´ {{ file.file_type|upper }} íŒŒì¼ì€ ì·¨ì•½ì½”ë“œë¡œ ì—…ë¡œë“œë˜ì–´ ì‹¤í–‰ ê°€ëŠ¥í•©ë‹ˆë‹¤!
              {% if file.file_type == 'python' %}
                (Python ìŠ¤í¬ë¦½íŠ¸)
              {% elif file.file_type == 'shell' %}
                (Shell ìŠ¤í¬ë¦½íŠ¸)
              {% elif file.file_type == 'php' %}
                (PHP ìŠ¤í¬ë¦½íŠ¸)
              {% elif file.file_type == 'exe' %}
                (Windows ì‹¤í–‰ íŒŒì¼)
              {% elif file.file_type == 'bat' %}
                (Windows ë°°ì¹˜ íŒŒì¼)
              {% else %}
                (ì‹¤í–‰ ê°€ëŠ¥í•œ íŒŒì¼)
              {% endif %}
            </div>

            <div class="execute-form">
              <label>ğŸ’» ëª…ë ¹ì–´:</label>
              <input type="text" id="cmd-{{ forloop.counter0 }}" placeholder="ls" value="ls">
              <button type="button" class="execute-btn" onclick="executeFile({{ forloop.counter0 }}, '{{ file.file_type }}')">
                âš¡ ì‹¤í–‰
              </button>
            </div>

            {# ì‹¤í–‰ ê²°ê³¼ ë°•ìŠ¤ #}
            <div id="result-{{ forloop.counter0 }}" class="result-box-terminal"></div>
          </div>
          {% endif %}
        </div>
        {% endfor %}
      {% else %}
        <p style="color: #999; text-align: center; padding: 40px;">
          ì•„ì§ ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.<br>
          ìœ„ì—ì„œ ëª¨ë“œë¥¼ ì„ íƒí•˜ê³  íŒŒì¼ì„ ì—…ë¡œë“œí•´ë³´ì„¸ìš”!
        </p>
      {% endif %}
    </div>

    <div class="attack-example">
      <h3>ğŸ“š ìœ„í—˜í•œ íŒŒì¼ í˜•ì‹</h3>

      <h4>ğŸ”´ ì‹¤í–‰ ê°€ëŠ¥í•œ íŒŒì¼ (ëª¨ë‘ ìœ„í—˜!)</h4>
      <ul>
        <li><strong>.py</strong> - Python ìŠ¤í¬ë¦½íŠ¸</li>
        <li><strong>.sh</strong> - Shell ìŠ¤í¬ë¦½íŠ¸ (Linux/Mac)</li>
        <li><strong>.php</strong> - PHP ì›¹ì‰˜</li>
        <li><strong>.jsp</strong> - Java Server Pages</li>
        <li><strong>.asp, .aspx</strong> - ASP ì›¹ì‰˜</li>
        <li><strong>.exe, .dll</strong> - Windows ì‹¤í–‰ íŒŒì¼</li>
        <li><strong>.bat, .cmd</strong> - Windows ë°°ì¹˜ íŒŒì¼</li>
        <li><strong>.ps1</strong> - PowerShell ìŠ¤í¬ë¦½íŠ¸</li>
      </ul>

      <h4>ğŸ”´ ì·¨ì•½ì½”ë“œ - ê³µê²© ì„±ê³µ ì‹œë‚˜ë¦¬ì˜¤</h4>
      <div class="code">
        # 1ë‹¨ê³„: ì›¹ì‰˜ ìƒì„± (ì˜ˆ: webshell.py)<br>
        import subprocess<br>
        import sys<br>
        result = subprocess.getoutput(sys.argv[1])<br>
        print(result)<br>
        <br>
        # 2ë‹¨ê³„: ì·¨ì•½ì½”ë“œë¡œ ì—…ë¡œë“œ<br>
        # â†’ ê²€ì¦ ì—†ì´ ì—…ë¡œë“œ ì„±ê³µ!<br>
        <br>
        # 3ë‹¨ê³„: "âš¡ ì‹¤í–‰" ë²„íŠ¼ìœ¼ë¡œ ëª…ë ¹ì–´ ì‹¤í–‰<br>
        # â†’ ls, pwd, cat /etc/passwd ë“± ì‹¤í–‰<br>
        <br>
        # ê²°ê³¼: ğŸ”´ ì„œë²„ ì œì–´ê¶Œ ì™„ì „ íƒˆì·¨!
      </div>

      <h4>âœ… ì•ˆì „ì½”ë“œ - ë°©ì–´ ë°©ë²•</h4>
      <ul>
        <li>ğŸ›¡ï¸ <strong>í™•ì¥ì í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸</strong> - ì´ë¯¸ì§€ë§Œ í—ˆìš© (.jpg, .png, .gif)</li>
        <li>ğŸ›¡ï¸ <strong>ìœ„í—˜ í™•ì¥ì ë¸”ë™ë¦¬ìŠ¤íŠ¸</strong> - .py, .sh, .exe ë“± ì°¨ë‹¨</li>
        <li>ğŸ›¡ï¸ <strong>MIME íƒ€ì… ê²€ì¦</strong> - Content-Type í™•ì¸</li>
        <li>ğŸ›¡ï¸ <strong>ì‹¤ì œ íŒŒì¼ ë‚´ìš© ê²€ì¦</strong> - Pillowë¡œ ì´ë¯¸ì§€ í™•ì¸</li>
        <li>ğŸ›¡ï¸ <strong>ì‹¤í–‰ ê¶Œí•œ ì œê±°</strong> - chmod 644ë¡œ ì €ì¥</li>
        <li>âœ… <strong>ê²°ê³¼</strong> - ì‹¤í–‰ ê°€ëŠ¥í•œ íŒŒì¼ ëª¨ë‘ ì°¨ë‹¨!</li>
      </ul>
    </div>

    <div class="links">
      <a href="{% url 'index' %}">ğŸ  ë©”ì¸ìœ¼ë¡œ</a>
    </div>
  </div>

  <script>
    function setMode(mode) {
      const input = document.getElementById('mode-input');
      input.value = mode;

      const vulnBtn = document.getElementById('btn-vuln');
      const safeBtn = document.getElementById('btn-safe');

      if (mode === 'vulnerable') {
        vulnBtn.classList.add('active');
        safeBtn.classList.remove('active');
      } else {
        safeBtn.classList.add('active');
        vulnBtn.classList.remove('active');
      }
    }

    // Ajaxë¡œ íŒŒì¼ ì‹¤í–‰
    function executeFile(fileIndex, fileType) {
      const cmdInput = document.getElementById(`cmd-${fileIndex}`);
      const resultBox = document.getElementById(`result-${fileIndex}`);
      const executeBtn = event.target;

      const cmd = cmdInput.value.trim();
      if (!cmd) {
        alert('ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”!');
        return;
      }

      // ë²„íŠ¼ ë¹„í™œì„±í™”
      executeBtn.disabled = true;
      executeBtn.textContent = 'â³ ì‹¤í–‰ ì¤‘...';

      // ê²°ê³¼ ë°•ìŠ¤ í‘œì‹œ
      resultBox.className = 'result-box-terminal show';
      resultBox.textContent = '$ ' + cmd + '\nì‹¤í–‰ ì¤‘...';

      // Ajax ìš”ì²­
      const formData = new FormData();
      formData.append('execute', 'true');
      formData.append('file_index', fileIndex);
      formData.append('cmd', cmd);
      formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

      fetch('{% url "file_upload" %}', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          resultBox.className = 'result-box-terminal show success';
          resultBox.textContent = '$ ' + cmd + '\n' + data.output;
        } else {
          resultBox.className = 'result-box-terminal show error';
          resultBox.textContent = '$ ' + cmd + '\nâŒ ' + data.error;
        }
      })
      .catch(error => {
        resultBox.className = 'result-box-terminal show error';
        resultBox.textContent = '$ ' + cmd + '\nâŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ' + error;
      })
      .finally(() => {
        executeBtn.disabled = false;
        executeBtn.textContent = 'âš¡ ì‹¤í–‰';
      });
    }
  </script>
</body>
</html>