<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>업로드 결과</title>
</head>
<body>
  <h1>업로드 결과</h1>
  
  <!-- 모드 표시 -->
  <h2>
    {% if mode == 'vulnerable' %}
      ❌ 취약 코드 모드
    {% else %}
      ✅ 안전 코드 모드
    {% endif %}
  </h2>
  
  <!-- 결과 상태 -->
  {% if success %}
    <p style="color: green; font-size: 1.2em;">
      <strong>✅ 업로드 성공!</strong>
    </p>
  {% else %}
    <p style="color: red; font-size: 1.2em;">
      <strong>업로드 차단됨 ({{ blocked_step }}단계에서 차단)</strong>
    </p>
    <p><strong>차단 사유:</strong> {{ blocked_reason }}</p>
  {% endif %}
  
  <hr>
  
  <!-- 파일 정보 -->
  <h3>파일 정보</h3>
  <table border="1" cellpadding="8">
    <tr><td>원본 파일명</td><td>{{ filename }}</td></tr>
    {% if saved_name %}<tr><td>저장된 파일명</td><td>{{ saved_name }}</td></tr>{% endif %}
    {% if file_ext %}<tr><td>확장자</td><td>{{ file_ext }}</td></tr>{% endif %}
    {% if content_type %}<tr><td>MIME 타입</td><td>{{ content_type }}</td></tr>{% endif %}
    {% if file_size %}<tr><td>파일 크기</td><td>{{ file_size }} bytes</td></tr>{% endif %}
    {% if image_size %}<tr><td>이미지 크기</td><td>{{ image_size }}</td></tr>{% endif %}
    {% if file_path %}<tr><td>저장 경로</td><td><code>{{ file_path }}</code></td></tr>{% endif %}
  </table>
  
  <!-- 실행된 로직 -->
  <h3>실행된 로직</h3>
  <p><code>{{ logic }}</code></p>
  
  <!-- 검증 단계 표시 (안전 모드일 때) -->
  {% if steps %}
  <h3>검증 단계</h3>
  <table border="1" cellpadding="8">
    <tr><th>단계</th><th>검증 항목</th><th>검사 내용</th><th>허용 조건</th><th>결과</th></tr>
    {% for s in steps %}
    <tr>
      <td>{{ s.step }}단계</td><td>{{ s.name }}</td><td>{{ s.check }}</td><td>{{ s.allowed }}</td>
      <td>{% if s.passed %}✅{% else %}❌{% endif %}</td>
    </tr>
    {% endfor %}
  </table>
  {% endif %}
  
  <!-- 파일 열기/실행 버튼 (업로드 성공 시) -->
  {% if success and file_url %}
  <hr>
  <h3>파일 접근</h3>
  <p>
    <a href="{{ file_url }}" target="_blank">
      <button>새 탭에서 파일 열기(파일 내용만 확인)</button>
    </a>
  </p>
  <p>
    <strong>파일 URL:</strong> 
    <code>{{ file_url }}</code>
  </p>
  
  <!-- 실행 가능한 파일인 경우 실행 UI 표시 -->
  {% if file_ext == '.py' or file_ext == '.php' or file_ext == '.ps1' or file_ext == '.bat' or file_ext == '.exe' %}
  <div>
    <h4>파일 실행 (취약점 시연)</h4>
    <p>
      <label>명령어 입력:</label><br>
      <input type="text" id="cmd-input" placeholder="dir, whoami, ipconfig" style="width: 300px; padding: 5px;" onkeypress="if(event.key==='Enter') executeFile()">
      <button onclick="executeFile()">실행</button>
    </p>
    <div id="exec-result" style="background: #1e1e1e; color: #0f0; width: 850px; padding: 10px; font-family: monospace; white-space: pre-wrap; display: none; margin-top: 10px;"></div>
  </div>
  
  <script>
    function executeFile() {
      const cmd = document.getElementById('cmd-input').value;
      const out = document.getElementById('exec-result');

      showRunning(out, cmd);

      fetch('{% url "execute_file" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: buildBody(cmd)
      })
        .then(r => r.json())
        .then(d => render(out, cmd, d))
        .catch(e => renderError(out, cmd, e));
    }

    function showRunning(out, cmd) {
      out.style.display = 'block';
      out.textContent = `$ ${cmd}\n실행 중...`;
    }

    function buildBody(cmd) {
      return `filename={{ saved_name }}&cmd=${encodeURIComponent(cmd)}`;
    }

    function render(out, cmd, data) {
      out.style.color = data.success ? '#0f0' : '#f00';
      out.textContent =
        `$ ${cmd}\n` + (data.success ? data.output : `❌ ${data.error}`);
    }

    function renderError(out, cmd, err) {
      out.style.color = '#f00';
      out.textContent = `$ ${cmd}\n❌ 네트워크 오류: ${err}`;
    }

  </script>
  {% endif %}
  {% endif %}
  {% endif %}
  
  <hr>
  
  <p>
    <a href="{% url 'file_upload' %}">← 다시 업로드하기</a> | 
    <a href="{% url 'index' %}">메인으로</a>
  </p>
</body>
</html>